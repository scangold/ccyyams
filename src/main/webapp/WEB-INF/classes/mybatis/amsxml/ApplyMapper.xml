<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fh.dao.ApplyMapper">
	<resultMap id="BaseResultMap" type="com.fh.entity.amsmodel.Apply">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jul 04 
			15:29:41 CST 2016. -->
		<id column="APPLY_ID" jdbcType="INTEGER" property="applyId" />
		<result column="APPLY_WHY" jdbcType="NVARCHAR" property="applyWhy" />
		<result column="USER_ID" jdbcType="CHAR" property="userId" />
		<result column="APPLY_TIME" jdbcType="TIMESTAMP" property="applyTime" />
		<result column="returntime" jdbcType="TIMESTAMP" property="returntime" />
		<result column="descs" jdbcType="VARCHAR" property="descs" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jul 04 
			15:29:41 CST 2016. -->
		APPLY_ID, APPLY_WHY, USER_ID, APPLY_TIME, returntime, descs
	</sql>
	<select id="selectByPrimaryKey" parameterType="java.lang.Integer"
		resultMap="BaseResultMap">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jul 04 
			15:29:41 CST 2016. -->
		select
		<include refid="Base_Column_List" />
		from ams_apply
		where APPLY_ID = #{applyId,jdbcType=INTEGER}
	</select>

	<select id="selectApply" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from ams_apply
	</select>
	<select id="selectByApplyKeymy" parameterType="java.lang.Integer"
		resultType="pd">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jul 04 
			15:29:41 CST 2016. -->
		select a.apply_id as applyId,a.apply_time as applyTime,a.apply_why as
		applyWhy ,a.descs,a.returnTime,a.user_id as userId,u.name,u.phone from
		ams_apply a,sys_user u where a.user_id=u.user_id and a.apply_id=
		#{applyId,jdbcType=INTEGER}

	</select>
	<!-- 分页查询 -->
	<select id="showApplylistPage" parameterType="page" resultType="pd">
			
		select spsf.APPLY_ID,spsf.APPLY_TIME,spsf.APPLY_WHY,spsf.descs,spsf.returntime,spsf.stute,spsf.USER_ID,spsf.filecount,sy.NAME from  (
select aps.APPLY_ID,aps.APPLY_TIME,aps.APPLY_WHY,aps.descs,aps.returntime,aps.stute,aps.USER_ID,apf.filecount  from 
(
select ap.APPLY_TIME,ap.APPLY_WHY,ap.descs,ap.returntime,ap.USER_ID,ap.APPLY_ID,aps.stute from ams_apply ap left join (	select apply_id,stute,user_id,user_id2 from ( select *,row_number() over(partition by
		apply_id order by
		stute_time desc) as rn from ams_apply_stute) as a
		where   <![CDATA[ rn<=1 ]]> ) aps on aps.apply_id=ap.APPLY_ID 
			
			where  1=1 
		
		<if test="pd.stute!= null and pd.stute != ''">
	
		<if test="pd.stute==0 "> 
		and   aps.stute=0
		
		</if>
		<if test="pd.stute==1 "> 
		and     aps.stute=1
		
		</if>
		<if test="pd.stute==3 "> 
		 and    aps.stute=3
		
		</if>
		<if test="pd.stute==2 "> 
		and   (  aps.stute=2 or aps.stute is null
		)
		</if>
		
		</if>
		<!--userid2 代表转交人  -->
		<if test="pd.userid2!= null and pd.userid2 != ''">
	     and (aps.user_id2=#{pd.userid2} 	<if test="pd.stute==2 "> 
          or  aps.stute=2 or aps.stute is null
		</if>
		)
		</if>
		<if test="pd.userid1!= null and pd.userid1 != ''">
	     and aps.user_id=#{pd.userid1} 	
		</if>
		<if test="pd.userid!= null and pd.userid != ''">
		and ap.USER_ID =#{pd.userid}
		</if>
		
) aps left join
(
		select
		a.apply_id,count(1) as filecount
		from ams_apply_file a group by
		a.apply_id 
		) apf
	on aps.APPLY_ID=apf.Apply_id


	) spsf  left join sys_user sy on sy.USER_ID= spsf.USER_ID 
		
		

	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jul 04 
			15:29:41 CST 2016. -->
		delete from ams_apply
		where APPLY_ID = #{applyId,jdbcType=INTEGER}
	</delete>
	<insert id="insert" parameterType="com.fh.entity.amsmodel.Apply"  keyProperty="applyId">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jul 04 
			15:29:41 CST 2016. -->
		insert into ams_apply (APPLY_ID, APPLY_WHY, USER_ID,
		APPLY_TIME,
		returntime, descs
		)
		values (#{applyId,jdbcType=INTEGER},
		#{applyWhy,jdbcType=NVARCHAR},
		#{userId,jdbcType=CHAR},
		#{applyTime,jdbcType=TIMESTAMP}, #{returntime,jdbcType=TIMESTAMP},
		#{descs,jdbcType=VARCHAR}
		)
	</insert>
	<insert id="insertSelective" parameterType="com.fh.entity.amsmodel.Apply"  useGeneratedKeys="true" keyProperty="applyId"
		>
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jul 04 
			15:29:41 CST 2016. -->
	
		insert into ams_apply
		<trim prefix="(" suffix=")" suffixOverrides=",">

			<if test="applyWhy != null">
				APPLY_WHY,
			</if>
			<if test="userId != null">
				USER_ID,
			</if>
			<if test="applyTime != null">
				APPLY_TIME,
			</if>
			<if test="returntime != null">
				returntime,
			</if>
			<if test="descs != null">
				descs,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">

			<if test="applyWhy != null">
				#{applyWhy,jdbcType=NVARCHAR},
			</if>
			<if test="userId != null">
				#{userId,jdbcType=CHAR},
			</if>
			<if test="applyTime != null">
				#{applyTime,jdbcType=TIMESTAMP},
			</if>
			<if test="returntime != null">
				#{returntime,jdbcType=TIMESTAMP},
			</if>
			<if test="descs != null">
				#{descs,jdbcType=VARCHAR},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.fh.entity.amsmodel.Apply">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jul 04 
			15:29:41 CST 2016. -->
		update ams_apply
		<set>
			<if test="applyWhy != null">
				APPLY_WHY = #{applyWhy,jdbcType=NVARCHAR},
			</if>
			<if test="userId != null">
				USER_ID = #{userId,jdbcType=CHAR},
			</if>
			<if test="applyTime != null">
				APPLY_TIME = #{applyTime,jdbcType=TIMESTAMP},
			</if>
			<if test="returntime != null">
				returntime = #{returntime,jdbcType=TIMESTAMP},
			</if>
			<if test="descs != null">
				descs = #{descs,jdbcType=VARCHAR},
			</if>
		</set>
		where APPLY_ID = #{applyId,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.fh.entity.amsmodel.Apply">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jul 04 
			15:29:41 CST 2016. -->
		update ams_apply
		set APPLY_WHY = #{applyWhy,jdbcType=NVARCHAR},
		USER_ID
		= #{userId,jdbcType=CHAR},
		APPLY_TIME =
		#{applyTime,jdbcType=TIMESTAMP},
		returntime =
		#{returntime,jdbcType=TIMESTAMP},
		descs = #{descs,jdbcType=VARCHAR}
		where APPLY_ID = #{applyId,jdbcType=INTEGER}
	</update>
	<select id="getApplyStutecount" resultType="pd">
	
	SELECT count(1)  as count ,stute
         FROM ams_apply_stute GROUP BY stute
	
	</select>
</mapper>